<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>♣ ♠ Solitaire ♥ ♦</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box }

		:root {
			--container-width: 1140px;

			--font-max: 18;
			--font-max-px: 18px;
		}

		html,
		body {
			height: 100%;
		}

		body {
			padding: 50px 30px;

			color: #e4ffea;
			font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;

			background-color: #111;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		.container {
			position: relative;
			width: 100%;
			height: 100%;
			max-width: var(--container-width);
			margin: auto;

			perspective: 2000px;
			perspective-origin: center;
		}

		/* Typography
		 **********************************************************************/

		* {
			font-size: calc(10px + (var(--font-max) - 10) * (100vw - 400px) / (1140 - 400))
		}

		@media (min-width: 1140px) {
			* {
				font-size: var(--font-max-px);
			}
		}

		/* Cards
		 **********************************************************************/

		.card {
			position: absolute;
			width: calc((100% / 7) - 1.5%);
			padding-top: 17%;

			color: #282828;

			background-color: #fff;
			border: 1px solid #282828;
			border-radius: 5px;

			transform-style: preserve-3d;
			transition: transform 1s ease;
		}

		.face,
		.back {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;

			border-radius: 5px;
			backface-visibility: hidden;
		}

		.face {
			display: flex;
			align-items: center;
			justify-content: center;

			background-color: #fff;
		}

		.back {
			position: absolute;
			background-color: #fff;
			transform: rotateY(180deg);
		}
		.back:before {
			content: '';
			position: absolute;
			top: 3%;
			right: 4.4%;
			bottom: 3%;
			left: 4%;

			background-color: #282828;
			border-radius: 3px;
		}

		.red {
			color: mediumvioletred;
		}

		.number {
			position: absolute;
			top: 4%;
			left: 5%;

			width: 1.4ch;

			--font-max: 25;
			--font-max-px: 25px;
			font-weight: bold;
			text-align: center;
			line-height: 0.9em;
		}
		.number:nth-child(2) {
			top: auto;
			left: auto;
			bottom: 4%;
			right: 5%;

			transform: rotate(180deg);
		}

		/* Cards: Types
		 **********************************************************************/

		.ace .pip {
			position: absolute;
			top: 50%;
			left: 50%;

			--font-max: 80;
			--font-max-px: 80px;

			transform: translate3d(-50%, -50%, 0);
		}
	</style>
</head>
<body>
<div class="container" id="board"></div>

<template id="card">
	<div class="card">
		<div class="face">
			<div class="number">X <div class="suit"></div></div>
			<div class="number">X <div class="suit"></div></div>
		</div>
		<div class="back"></div>
	</div>
</template>

<template id="ace">
	<div class="pip suit"></div>
</template>

<template id="one">
	<p>one</p>
</template>

<template id="two">
	<p>two</p>
</template>

<template id="three">
	<p>three</p>
</template>

<template id="four">
	<p>four</p>
</template>

<template id="five">
	<p>five</p>
</template>

<template id="six">
	<p>six</p>
</template>

<template id="seven">
	<p>seven</p>
</template>

<template id="eight">
	<p>eight</p>
</template>

<template id="nine">
	<p>nine</p>
</template>

<template id="jack">
	<p>jack</p>
</template>

<template id="queen">
	<p>queen</p>
</template>

<template id="king">
	<p>king</p>
</template>

<script>

	// Helpers
	// =========================================================================

	const tmpl = id => document.getElementById(id).content.firstElementChild;
	const impt = id => {
		if (!templates.hasOwnProperty(id))
			templates[id] = document.importNode(tmpl(id), true);

		return templates[id].cloneNode(true);
	};

	function wordToNumber (number) {
		switch (number) {
			case 'ace':   return 'A';
			case 'one':   return '1';
			case 'two':   return '2';
			case 'three': return '3';
			case 'four':  return '4';
			case 'five':  return '5';
			case 'six':   return '6';
			case 'seven': return '7';
			case 'eight': return '8';
			case 'nine':  return '9';
			case 'jack':  return 'J';
			case 'queen': return 'Q';
			case 'king':  return 'K';
		}
	}

	function shuffle (array) {
		for (let i = array.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[array[i], array[j]] = [array[j], array[i]];
		}
	}

	function sleep (dur) {
		return new Promise(resolve => {
			setTimeout(resolve, dur);
		});
	}

	const trnslt = v => !v ? 0 : isNaN(v) ? v : v + 'px'
		, rtte = v => !v ? '0deg' : isNaN(v) ? v : v + 'deg';

	const updateCardTransform = card => {
		card.style.transform = `
			translate3d(
				${trnslt(card.translate.x)},
				${trnslt(card.translate.y)},
				${trnslt(card.translate.z)}
			)
			rotateX(${rtte(card.rotate.x)})
			rotateY(${rtte(card.rotate.y)})
			rotateZ(${rtte(card.rotate.z)})
		`.replace(/\r\n\s/g, '');
	};

	const makeCard = (suit, face, colour) => {
		const c = impt('card')
			, f = impt(face);

		if (colour === 'red')
			c.classList.add('red');

		c.classList.add(face);
		c.getElementsByClassName('face')[0].appendChild(f);

		const n = c.getElementsByClassName('number');
		for (let x = 0, l = n.length; x < l; ++x)
			n[x].firstChild.textContent = wordToNumber(face);

		const s = c.getElementsByClassName('suit');
		for (let x = 0, l = s.length; x < l; ++x)
			s[x].textContent = suit;

		c.translate = {
			_x: null,
			_y: null,
			_z: null,

			set x (v) { this._x = v; updateCardTransform(c) },
			set y (v) { this._y = v; updateCardTransform(c) },
			set z (v) { this._z = v; updateCardTransform(c) },

			get x () { return this._x },
			get y () { return this._y },
			get z () { return this._z },
		};

		c.rotate = {
			_x: null,
			_y: 180,
			_z: null,

			set x (v) { this._x = v; updateCardTransform(c) },
			set y (v) { this._y = v; updateCardTransform(c) },
			set z (v) { this._z = v; updateCardTransform(c) },

			get x () { return this._x },
			get y () { return this._y },
			get z () { return this._z },
		};

		c.flipUp = () => {
			c.rotate.y = 360;
		};

		c.flipDown = () => {
			c.rotate.y = 180;
		};

		c.column = col => {
			c.translate.x = `calc((100% * ${col}) + ((700% * (1 / 7)) / 7) * ${col})`;
		};

		c.row = row => {
			c.translate.y = row === -1 ? 0 : `calc(130% + (30% * ${row}))`;
		};

		deck.push(c);
		return c;
	};

	// Variables
	// =========================================================================

	const board = document.getElementById('board')
		, suits = ['♣', '♠', '♥', '♦']
		, faces = [
			'ace', 'one', 'two', 'three', 'four', 'five', 'six', 'seven',
			'eight', 'nine', 'jack', 'queen', 'king',
		];

	const templates = {}
		, deck = []
		, columns = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };

	suits.forEach((suit, i) => {
		faces.forEach((face, x) => {
			const c = makeCard(suit, face, i > 1 ? 'red' : 'black');
			c.translate.z = (x + i * faces.length);
			board.appendChild(c);
		});
	});

	const deckLength = deck.length;

	// Actions
	// =========================================================================

	async function deal () {
		Object.keys(columns).forEach(i => {
			columns[i] = [];
		});

		deck.forEach(card => {
			card.flipDown();
			card.column(0);
			card.row(-1);
		});

		shuffle(deck);

		deck.forEach((card, i) => {
			card.translate.z = i;
			card.style.zIndex = i;
		});

		let cardI = 0,
			colI = 7,
			rowI = 0;

		while (colI--) {
			let i = 0;
			while (i <= colI) {
				const card = deck[deckLength - (cardI + 1)];
				card.column(6 - i);
				card.row(rowI);
				card.translate.z = rowI * 0.5;
				card.style.zIndex = deckLength + rowI;
				columns[i].push(card);
				cardI++;
				i++;
				await sleep(50);
			}

			rowI++;
		}

		await sleep(500);

		Object.values(columns).reverse().forEach((cards, i) => {
			setTimeout(() => {
				cards.slice(-1)[0].flipUp();
			}, 100 * i);
		});
	}

	setTimeout(() => {
		deal();
	}, 1000);

</script>
</body>
</html>
